<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<meta name="theme-color" content="#f5f5f0" media="(prefers-color-scheme: light)" />
<meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)" />
  <title>Spanish Tenses & Ser/Estar</title>
  <style>
/* Quiz app – simple, robust, dark/light */
:root {
  --bg: #f5f5f0;
  --surface: #ffffff;
  --text: #1a1a1a;
  --text-muted: #555;
  --accent: #2563eb;
  --accent-hover: #1d4ed8;
  --correct: #15803d;
  --wrong: #b91c1c;
  --border: #e0e0e0;
  --shadow: rgba(0, 0, 0, 0.08);
  --code-bg: #e8e8e4;
  --code-border: #ccc;
}
[data-theme="dark"] {
  --bg: #1a1a1a;
  --surface: #2d2d2d;
  --text: #f0f0f0;
  --text-muted: #a0a0a0;
  --accent: #3b82f6;
  --accent-hover: #60a5fa;
  --correct: #22c55e;
  --wrong: #ef4444;
  --border: #404040;
  --shadow: rgba(0, 0, 0, 0.3);
  --code-bg: #252525;
  --code-border: #444;
}
*,*::before,*::after{box-sizing:border-box;}
html{font-size:100%;-webkit-text-size-adjust:100%;overflow-x:hidden;}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh;overflow-x:hidden;}
.app{max-width:42rem;margin:0 auto;min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;padding:1rem;padding-left:max(1rem,env(safe-area-inset-left));padding-right:max(1rem,env(safe-area-inset-right));padding-bottom:max(1rem,env(safe-area-inset-bottom));}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;padding-top:env(safe-area-inset-top,0);flex-wrap:wrap;gap:0.5rem;}
.title{margin:0;font-size:1.5rem;font-weight:700;}
.header-actions{display:flex;align-items:center;gap:0.5rem;}
.theme-toggle{width:2.75rem;height:2.75rem;min-width:2.75rem;min-height:2.75rem;padding:0;display:inline-flex;align-items:center;justify-content:center;font-size:1.25rem;line-height:1;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:50%;cursor:pointer;-webkit-tap-highlight-color:transparent;}
.theme-toggle:hover{background:var(--border);}
.main{flex:1;}
.dashboard,.session-summary{background:var(--surface);border:1px solid var(--border);border-radius:0.5rem;padding:1.5rem;box-shadow:0 2px 8px var(--shadow);}
.dashboard h2,.session-summary h2{margin:0 0 1rem;font-size:1.25rem;font-weight:600;}
.dashboard p,.session-summary p{margin:0 0 0.75rem;font-size:0.9375rem;color:var(--text-muted);}
.dashboard label{display:block;margin-bottom:0.25rem;font-size:0.875rem;font-weight:500;}
.dashboard select{margin-bottom:1rem;padding:0.75rem 1rem;min-height:2.75rem;font-size:1rem;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:0.375rem;min-width:8rem;-webkit-appearance:none;appearance:none;cursor:pointer;}
.dashboard .failed-hint{margin-bottom:1rem;padding:0.75rem;background:var(--code-bg);border:1px solid var(--code-border);border-radius:0.375rem;font-size:0.875rem;}
.dashboard .failed-hint strong{color:var(--wrong);}
.stats-chart{margin-bottom:1.25rem;}
.stats-chart-bar{display:flex;height:1.75rem;border-radius:0.375rem;overflow:hidden;background:var(--border);}
.stats-chart-segment{transition:width 0.3s ease;}
.stats-chart-segment.segment-failed,.stats-chart-legend .dot-failed{background:var(--wrong);}
.stats-chart-segment.segment-rest,.stats-chart-legend .dot-rest{background:var(--accent);}
.stats-chart-segment.segment-correct,.stats-chart-legend .dot-correct{background:var(--correct);}
.stats-chart-segment.segment-wrong,.stats-chart-legend .dot-wrong{background:var(--wrong);}
.stats-chart-legend{display:flex;flex-wrap:wrap;gap:1rem;margin:0.5rem 0 0;font-size:0.8125rem;color:var(--text-muted);}
.stats-chart-legend span{display:inline-flex;align-items:center;gap:0.35rem;}
.stats-chart-legend .dot{width:0.5rem;height:0.5rem;border-radius:50%;}
.session-summary .stats{margin:1rem 0;padding:0.75rem 1rem;background:var(--bg);border-radius:0.375rem;font-size:0.9375rem;}
.session-summary .failed-list{margin:1rem 0;padding-left:1.25rem;font-size:0.9375rem;}
.session-summary .failed-list li{margin:0.25rem 0;}
.session-summary .next-tip{margin-top:1rem;font-size:0.875rem;color:var(--text-muted);}
.progress{margin:0 0 1rem;font-size:0.875rem;color:var(--text-muted);}
.quiz-stats{font-weight:500;}
.quiz-stats .correct-num{color:var(--correct);}
.quiz-stats .wrong-num{color:var(--wrong);}
.question-card{background:var(--surface);border:1px solid var(--border);border-radius:0.5rem;padding:1.25rem;box-shadow:0 2px 8px var(--shadow);}
.question-title{margin:0 0 1rem;font-size:1.25rem;font-weight:600;}
.question-illustration,.result-illustration{margin-bottom:1rem;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:0.8125rem;line-height:1.45;white-space:pre-wrap;word-break:break-word;text-align:left;overflow-x:auto;padding:0.875rem 1rem;background:var(--code-bg);border:1px solid var(--code-border);border-radius:0.375rem;}
.question-illustration:empty,.result-illustration:empty{display:none;}
.instruction{margin:0 0 0.75rem;font-size:0.875rem;color:var(--text-muted);}
.options-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:0.5rem;}
.option{display:flex;align-items:flex-start;gap:0.5rem;width:100%;min-height:2.75rem;padding:0.75rem 1rem;text-align:left;font-size:1rem;background:var(--bg);color:var(--text);border:2px solid var(--border);border-radius:0.375rem;cursor:pointer;transition:border-color 0.15s,background 0.15s;-webkit-tap-highlight-color:transparent;touch-action:manipulation;}
.option-num{flex-shrink:0;font-weight:700;color:var(--text-muted);}
.option:hover:not(.option--disabled),.option:focus-visible{border-color:var(--accent);outline:none;}
.option--disabled{cursor:default;opacity:0.85;}
.option--correct{border-color:var(--correct);background:rgba(21,128,61,0.12);}
.option--wrong{border-color:var(--wrong);background:rgba(185,28,28,0.12);}
.result-section{background:var(--surface);border:1px solid var(--border);border-radius:0.5rem;padding:1.25rem;box-shadow:0 2px 8px var(--shadow);position:relative;}
.result-section.hidden{display:none;}
.result-actions{margin-top:1rem;position:relative;z-index:2;cursor:pointer;}
.result-section .btn-primary{position:relative;z-index:2;cursor:pointer;pointer-events:auto;}
.result-badge{margin-bottom:1rem;padding:0.5rem 0.75rem;border-radius:0.375rem;font-weight:600;font-size:0.875rem;}
.result-badge--correct{background:rgba(21,128,61,0.2);color:var(--correct);}
.result-badge--wrong{background:rgba(185,28,28,0.2);color:var(--wrong);}
.result-title{margin:0 0 0.75rem;font-size:1.25rem;font-weight:600;}
.result-heading{margin:1rem 0 0.25rem;font-size:0.875rem;font-weight:600;color:var(--text-muted);}
.result-heading:first-of-type{margin-top:0;}
.result-text{margin:0;font-size:0.9375rem;}
.result-detailed{color:var(--text-muted);white-space:pre-line;}
.btn{min-height:2.75rem;padding:0.75rem 1.25rem;font-size:1rem;font-weight:500;border:none;border-radius:0.375rem;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation;}
.btn-primary{margin-top:1rem;width:100%;background:var(--accent);color:white;}
.btn-primary:hover,.btn-primary:focus-visible{background:var(--accent-hover);outline:none;}
.footer{margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--border);}
.hint{margin:0;font-size:0.75rem;color:var(--text-muted);}
.keyboard-tips{margin:0;font-size:0.8125rem;color:var(--text-muted);}
.keyboard-tips strong{display:block;margin-bottom:0.25rem;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.03em;}
.keyboard-tips ul{margin:0.25rem 0 0;padding-left:1.25rem;}
.keyboard-tips li{margin:0.15rem 0;}
kbd{padding:0.125rem 0.375rem;font-size:0.7em;background:var(--surface);border:1px solid var(--border);border-radius:0.25rem;}
@media (max-width: 768px),(pointer: coarse){.keyboard-tips{display:none!important;}}
@media (max-width: 480px){
.app{padding-left:max(0.75rem,env(safe-area-inset-left));padding-right:max(0.75rem,env(safe-area-inset-right));}
.dashboard,.session-summary{padding:1.25rem;}
.question-card,.result-section{padding:1rem;}
.title{font-size:1.25rem;}
.dashboard h2,.session-summary h2{font-size:1.125rem;}
.question-title,.result-title{font-size:1.125rem;}
.options-list{gap:0.625rem;}
.option{min-height:3rem;padding:0.875rem 1rem;}
}
@media (pointer: coarse){
.option,.btn,.theme-toggle,.dashboard select{min-height:2.75rem;}
.option{padding:0.875rem 1rem;}
}
.nav-tabs{display:flex;gap:0.5rem;margin:0;}
.nav-tab{height:2.75rem;min-height:2.75rem;min-width:2.75rem;padding:0 0.6rem;display:inline-flex;align-items:center;justify-content:center;font-size:0.875rem;font-weight:600;border:1px solid var(--border);border-radius:0.375rem;background:var(--surface);color:var(--text);cursor:pointer;-webkit-tap-highlight-color:transparent;}
.nav-tab:hover{border-color:var(--accent);}
.nav-tab.active{background:var(--accent);color:white;border-color:var(--accent);}
.page{display:none;}
.page.active{display:block;}
.learn-intro{margin:0 0 1rem;font-size:0.9375rem;color:var(--text-muted);}
.learn-search-row{display:flex;flex-wrap:wrap;align-items:center;gap:0.5rem;margin-bottom:1rem;}
.learn-search-row .learn-search-box{flex:1 1 12rem;min-width:0;min-height:2.5rem;padding:0.5rem 0.75rem;font-size:1rem;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:0.375rem;}
.learn-search-row .learn-search-box::placeholder{color:var(--text-muted);}
.learn-search-row .learn-count{font-size:0.875rem;color:var(--text-muted);white-space:nowrap;}
.learn-search-row .learn-collapse-btn{min-height:2.5rem;padding:0.5rem 0.75rem;font-size:0.875rem;border:1px solid var(--border);border-radius:0.375rem;background:var(--surface);color:var(--text);cursor:pointer;}
.learn-search-row .learn-collapse-btn:hover{border-color:var(--accent);}
.learn-no-results{margin:0 0 1rem;font-size:0.9375rem;color:var(--text-muted);}
.learn-list{list-style:none;margin:0;padding:0;}
.learn-item{background:var(--surface);border:1px solid var(--border);border-radius:0.375rem;margin-bottom:0.5rem;box-shadow:0 1px 3px var(--shadow);overflow:hidden;}
.learn-item.no-match{display:none;}
.learn-btn{width:100%;text-align:left;padding:0.75rem 1rem;font-size:1rem;font-weight:600;border:none;background:none;color:var(--text);cursor:pointer;-webkit-tap-highlight-color:transparent;}
.learn-btn:hover{background:var(--bg);}
.learn-btn::before{content:\"\\25B6 \";font-size:0.75em;opacity:0.7;}
.learn-item.expanded .learn-btn::before{content:\"\\25BC \";}
.learn-spoiler{display:none;padding:0 1rem 1rem;border-top:1px solid var(--border);}
.learn-item.expanded .learn-spoiler{display:block;}
.learn-spoiler p{margin:0.5rem 0 0;font-size:0.9375rem;color:var(--text);line-height:1.5;}
.learn-spoiler p:first-child{margin-top:0;}
.learn-spoiler pre{margin:0.75rem 0 0;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:0.8125rem;line-height:1.45;white-space:pre-wrap;word-break:break-word;padding:0.875rem 1rem;background:var(--code-bg);border:1px solid var(--code-border);border-radius:0.375rem;overflow-x:auto;}
.hidden{display:none!important;}
  </style>
</head>
<body>
  <div id="app" class="app">
    <header class="header">
      <h1 class="title">Spanish Tenses & Ser/Estar</h1>
      <div class="header-actions">
        <nav class="nav-tabs" role="tablist" aria-label="Quiz or reference">
          <button type="button" id="tab-quiz" class="nav-tab active" role="tab" aria-selected="true" aria-controls="page-quiz">Quiz</button>
          <button type="button" id="tab-learn" class="nav-tab" role="tab" aria-selected="false" aria-controls="page-learn">Learn</button>
        </nav>
        <button type="button" id="theme-toggle" class="theme-toggle" aria-label="Toggle dark/light theme"></button>
      </div>
    </header>
    <div id="page-quiz" class="page active" role="tabpanel">
    <main class="main">
      <section id="dashboard-section" class="dashboard-section" aria-label="Start learning">
        <form id="dashboard-form" class="dashboard">
          <h2 id="dashboard-title">Start learning</h2>
          <div id="dashboard-chart" class="stats-chart" aria-hidden="true"></div>
          <p id="dashboard-total">Total questions in the quiz: <strong id="total-count">0</strong></p>
          <p>Choose how many questions to answer in this try:</p>
          <label for="question-count">Number of questions</label>
          <select id="question-count" aria-label="Number of questions for this try"></select>
          <div id="failed-hint" class="failed-hint hidden"></div>
          <button type="submit" id="start-btn" class="btn btn-primary">Start</button>
        </form>
      </section>
      <section id="quiz-section" class="quiz-section hidden">
        <p class="progress" id="progress" aria-live="polite"></p>
        <article id="question-card" class="question-card" aria-labelledby="question-title">
          <h2 id="question-title" class="question-title"></h2>
          <div id="question-illustration" class="question-illustration" aria-hidden="true"></div>
          <p class="instruction" id="instruction">Select the correct short explanation (1–4 or click):</p>
          <ul id="options-list" class="options-list" role="listbox" aria-label="Answer options"></ul>
        </article>
      </section>
      <section id="result-section" class="result-section hidden" aria-live="polite">
        <div id="result-badge" class="result-badge"></div>
        <article id="result-card" class="result-card">
          <h2 id="result-title" class="result-title"></h2>
          <div id="result-illustration" class="result-illustration" aria-hidden="true"></div>
          <h3 class="result-heading">Short explanation</h3>
          <p id="result-short" class="result-text"></p>
          <h3 class="result-heading">Detailed explanation</h3>
          <p id="result-detailed" class="result-text result-detailed"></p>
        </article>
        <form id="result-form" class="result-actions">
          <button type="submit" id="next-btn" class="btn btn-primary">Next question</button>
        </form>
      </section>
      <section id="session-summary-section" class="session-summary-section hidden" aria-live="polite">
        <div class="dashboard session-summary">
          <h2>Session complete</h2>
          <div id="session-chart" class="stats-chart" aria-hidden="true"></div>
          <div id="session-stats" class="stats"></div>
          <div id="session-failed-wrap" class="hidden">
            <p><strong>Questions to review (suggested first next try):</strong></p>
            <ul id="session-failed-list" class="failed-list"></ul>
          </div>
          <p class="next-tip" id="session-next-tip">Failed questions will appear first when you start your next try.</p>
          <button type="button" id="back-to-dashboard-btn" class="btn btn-primary">Back to dashboard</button>
        </div>
      </section>
    </main>
    <footer class="footer">
      <div class="keyboard-tips" aria-label="Keyboard shortcuts">
        <strong>Keyboard shortcuts</strong>
        <ul>
          <li><kbd>1</kbd>–<kbd>4</kbd> — select an answer</li>
          <li><kbd>Enter</kbd> — Start (dashboard), Next / Finish (after answering)</li>
          <li><kbd>T</kbd> — toggle dark/light theme</li>
        </ul>
      </div>
    </footer>
    </div>
    <div id="page-learn" class="page learn-page" role="tabpanel" aria-labelledby="tab-learn" hidden>
      <p class="learn-intro">Study pretérito imperfecto, perfecto compuesto, perfecto simple, and ser/estar. Then try the Quiz tab.</p>
      <div class="learn-search-row">
        <label for="learn-search-box" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">Search topics</label>
        <input type="text" id="learn-search-box" class="learn-search-box" placeholder="Search topics..." aria-label="Search topics" />
        <span id="learn-count" class="learn-count">0</span>
        <button type="button" id="learn-collapse-btn" class="learn-collapse-btn">Collapse all</button>
        <button type="button" id="learn-expand-btn" class="learn-collapse-btn">Expand all</button>
      </div>
      <p id="learn-no-results" class="learn-no-results hidden">No topics match. Try different keywords.</p>
      <ul id="learn-list" class="learn-list"></ul>
    </div>
  </div>
  <script>
(function () {
  var STORAGE_THEME_KEY = "quiz-theme";
  var STORAGE_FAILED_KEY = "quiz-failed-ids-spanish-tenses";

  var QUESTIONS = [
    { id: "q1", title: "What is the pretérito imperfecto and when do we use it?", shortExplanation: "Imperfecto: habits, background, description (e.g. jugaba, era).", detailedExplanation: "The pretérito <strong>imperfecto</strong> describes past actions that were in progress, habitual, or repeated, and is used for background or description. It does not focus on the beginning or end of the action.\n\nExamples:\n1. Cuando era niño, siempre <strong>jugaba</strong> en el parque — childhood is a period, 'playing' was a repeated habit → <strong>imperfecto</strong>.\n2. Mientras <strong>estudiaba</strong>, <strong>sonó</strong> el teléfono — estudiaba sets the background; sonó is the single event that interrupted → <strong>imperfecto</strong> + simple.", illustration: "Imperfecto – typical uses:\n\n  • Habit / repetition:  Jugaba al fútbol.\n  • Description:        Era alto. Tenía ojos verdes.\n  • Background:        Mientras cocinaba, ...\n  • Time / age:        Cuando tenía 10 años...\n\n  -ar: -aba, -abas, -aba, -ábamos, -abais, -aban\n  -er/-ir: -ía, -ías, -ía, -íamos, -íais, -ían", priority: 1 },
    { id: "q2", title: "What is the pretérito perfecto compuesto and when do we use it?", shortExplanation: "Perfecto compuesto: haber + participio (e.g. hoy, esta semana).", detailedExplanation: "The pretérito <strong>perfecto compuesto</strong> is formed with present haber + past participle. It links a past action to the present: the time period is not finished or the result still matters.\n\n• Example: Hoy <strong>he comido</strong> paella — 'hoy' is still the current day → <strong>compuesto</strong>.\n• Compare: Ayer <strong>comí</strong> paella — 'ayer' is a finished period → <strong>simple</strong>.\n• Esta semana <strong>he trabajado</strong> mucho — the week is still ongoing → <strong>compuesto</strong>.\n\nUse with: hoy, esta mañana, esta semana, este año (when the period is not over).", illustration: "Perfecto compuesto:\n\n  haber (presente) + participio\n  he   has   ha   hemos   habéis   han\n  + -ado / -ido (regular)\n\n  Typical with: hoy, esta mañana, esta semana,\n  este año, todavía no, ya, nunca (in this period)", priority: 2 },
    { id: "q3", title: "What is the pretérito perfecto simple (indefinido) and when do we use it?", shortExplanation: "Perfecto simple: completed past (e.g. ayer, el año pasado).", detailedExplanation: "The pretérito <strong>perfecto simple</strong> (indefinido) expresses completed past actions, at a specific moment or in a period that is over.\n\n• Example: Ayer <strong>llamé</strong> a mi madre — 'ayer' is a finished day → <strong>simple</strong>.\n• El año pasado <strong>viajé</strong> a México — the year is over → <strong>simple</strong>.\n\nUnlike imperfecto, the simple past does not describe ongoing or repeated action; it reports what happened.\n\nUse with: ayer, anoche, el año pasado, en 2020, la semana pasada.", illustration: "Perfecto simple (indefinido):\n\n  -ar: -é, -aste, -ó, -amos, -asteis, -aron\n  -er/-ir: -í, -iste, -ió, -imos, -isteis, -ieron\n\n  Use with: ayer, anoche, el lunes pasado,\n  hace dos años, en 2019, la semana pasada", priority: 3 },
    { id: "q4", title: "When do we use imperfecto vs perfecto simple in the same sentence?", shortExplanation: "Imperfecto = background; simple = event. Mientras [imperfecto], [simple].", detailedExplanation: "In narratives we combine both: <strong>imperfecto</strong> sets the scene or action in progress; <strong>simple</strong> states what happened (the event).\n\nExamples:\n1. Mientras ella <strong>cocinaba</strong>, yo <strong>leí</strong> el periódico — cocinar = background (<strong>imperfecto</strong>), leer = completed action (<strong>simple</strong>).\n2. <strong>Estaba durmiendo</strong> cuando <strong>sonó</strong> el despertador — background + interrupting event.\n3. Cuando era pequeño, mi abuelo me <strong>contaba</strong> historias — both habitual → both <strong>imperfecto</strong>.\n\nSummary:\n• <strong>Imperfecto</strong> = duration, habit, description, background.\n• <strong>Simple</strong> = one-off, completed event.", illustration: "Combining both:\n\n  Mientras [imperfecto], [simple].\n  Cuando [imperfecto], [simple].\n\n  Estaba leyendo (background) cuando\n  llegó (event) mi amigo.", priority: 4 },
    { id: "q5", title: "When do we use ser? (identity, origin, time, permanent traits)", shortExplanation: "Ser: identity, origin, profession, time, permanent traits.", detailedExplanation: "<strong>Ser</strong> is used for more permanent or defining characteristics:\n\n1. Identity — <strong>Soy</strong> María.\n2. Origin — <strong>Es</strong> de Madrid.\n3. Profession — <strong>Es</strong> médico.\n4. Time — <strong>Es</strong> la una. La reunión <strong>es</strong> a las diez.\n5. Permanent traits — <strong>Es</strong> alto.\n6. Material — La mesa <strong>es</strong> de madera.\n\nWhy not estar? <strong>Estar</strong> is for location, temporary states, and conditions.\n\n<strong>Ser</strong> answers 'what/who is it?'; <strong>estar</strong> answers 'where is it? / how is it (right now)?'", illustration: "SER – DOCTOR (mnemonic)\n  D Description (permanent)\n  O Origin\n  C Characteristic\n  T Time\n  O Occupation\n  R Relation\n\n  soy, eres, es, somos, sois, son\n  (plus era, fue, etc. in past)", priority: 5 },
    { id: "q6", title: "When do we use estar? (location, temporary state, condition)", shortExplanation: "Estar: location, temporary state, condition.", detailedExplanation: "<strong>Estar</strong> is used for:\n\n1. Location — <strong>Estoy</strong> en casa.\n2. Temporary states — María <strong>está</strong> cansada hoy.\n3. Conditions or results — La ventana <strong>está</strong> abierta; <strong>Está</strong> muerto.\n4. Progressive (-ando/-iendo) — <strong>Está</strong> lloviendo.\n\n• María <strong>está</strong> cansada hoy — tiredness is temporary → <strong>estar</strong>.\n• La sopa <strong>está</strong> deliciosa (this bowl, right now) vs <strong>es</strong> deliciosa (in general).\n\nSome adjectives change meaning with ser/estar: <strong>ser</strong> listo = clever; <strong>estar</strong> listo = ready.\n\n<strong>Estar</strong> = where? how (temporarily)?", illustration: "ESTAR – PLACE (mnemonic)\n  P Position\n  L Location\n  A Action (-ando/-iendo)\n  C Condition\n  E Emotion\n\n  estoy, estás, está, estamos, estáis, están", priority: 6 },
    { id: "q7", title: "Ser vs estar with the same adjective (e.g. listo, aburrido)", shortExplanation: "Ser = inherent trait; estar = current state (e.g. listo: clever vs ready).", detailedExplanation: "Some adjectives work with both <strong>ser</strong> and <strong>estar</strong>; the meaning changes:\n\n• <strong>ser</strong> listo = clever (trait)  |  <strong>estar</strong> listo = ready (condition)\n• <strong>ser</strong> aburrido = boring (personality)  |  <strong>estar</strong> aburrido = bored (feeling)\n• <strong>ser</strong> vivo = sharp/clever  |  <strong>estar</strong> vivo = alive\n• <strong>ser</strong> bueno = good (quality)  |  la comida <strong>está</strong> buena = tastes good now\n\nSummary:\n• <strong>Ser</strong> = defining or permanent.\n• <strong>Estar</strong> = temporary state or result.\n\nWhen in doubt: in general (<strong>ser</strong>) or right now / this situation (<strong>estar</strong>)?", illustration: "Same adjective, different meaning:\n\n  ser listo    = clever\n  estar listo  = ready\n  ser vivo     = sharp\n  estar vivo   = alive\n  ser aburrido = boring\n  estar aburrido = bored", priority: 7 },
    { id: "q8", title: "Cuando la ambulancia llegó, el anciano ya ___ muerto en el suelo.", shortExplanation: "Estaba (estar).", options: [ { text: "Estaba (estar).", correct: true }, { text: "Era (ser).", correct: false }, { text: "Está (estar).", correct: false }, { text: "Fue (ser).", correct: false } ], detailedExplanation: "Correct: Cuando la ambulancia llegó, el anciano ya <strong>estaba</strong> muerto en el suelo.\n\nWhy <strong>estar</strong>?\n• <strong>Muerto</strong> describes a condition or result of a change (he had died), not an inherent identity.\n• We use <strong>estar</strong> for states that someone 'enters' or 'becomes' — death, marriage, pregnancy — even if they last a long time.\n• <strong>Estaba</strong> (imperfecto) fits the past context (when the ambulance arrived).\n\nWhy not <strong>ser</strong>?\n• <strong>Era</strong> muerto / <strong>Fue</strong> muerto would treat 'dead' as an identity, which we don't do in Spanish.\n\nRule: Use <strong>estar</strong> (not <strong>ser</strong>) for result of change or current condition — including muerto, casado, divorciado, embarazada, despierto, dormido.", illustration: "Result/condition → estar\n\n  estar muerto, casado, divorciado,\n  embarazada, despierto, dormido\n\n  (change of state, not inherent trait)", priority: 8 },
    { id: "q9", title: "Ayer ___ (llamar) a mi madre.", shortExplanation: "Llamé (perfecto simple).", options: [ { text: "Llamé (perfecto simple).", correct: true }, { text: "He llamado (perfecto compuesto).", correct: false }, { text: "Llamaba (imperfecto).", correct: false }, { text: "Llamo (presente).", correct: false } ], detailedExplanation: "Correct: Ayer <strong>llamé</strong> a mi madre.\n\nWhy <strong>simple</strong>?\n• 'Ayer' is a completed day — the time period is over.\n• The action is a single, completed event.\n\nWe do not use perfecto compuesto (<strong>he llamado</strong>) with ayer — that tense links the past to the present (e.g. hoy he llamado).\n\nRule: finished time (ayer, anoche, la semana pasada) → <strong>simple</strong> past.", illustration: "Ayer + [action]\n  → perfecto simple (finished day)\n\n  Ayer llamé / comí / salí\n  (not: ayer he llamado)", priority: 9 },
    { id: "q10", title: "Cuando era niño, siempre ___ (jugar) en el parque.", shortExplanation: "Jugaba (imperfecto).", options: [ { text: "Jugaba (imperfecto).", correct: true }, { text: "Jugué (perfecto simple).", correct: false }, { text: "He jugado (perfecto compuesto).", correct: false }, { text: "Estaba jugando (imperfecto progresivo).", correct: false } ], detailedExplanation: "Correct: Cuando era niño, siempre <strong>jugaba</strong> en el parque.\n\nWhy <strong>imperfecto</strong>?\n• We are describing a habit or repeated action — something that used to happen regularly.\n• 'Siempre' and 'cuando era niño' point to a period and repetition, not a one-off event.\n\nIf we said <strong>jugué</strong> we would mean 'I played (once)'.\n\nRule: habits, repeated actions, or 'used to' in the past → <strong>imperfecto</strong>.\n\nAnother example: Antes <strong>vivía</strong> en Madrid.", illustration: "Habit / 'used to' → imperfecto\n\n  Siempre jugaba / Íbamos cada verano\n  Cuando era niño...\n  (repeated, not one event)", priority: 10 },
    { id: "q11", title: "Hoy ___ (comer) paella.", shortExplanation: "He comido (perfecto compuesto).", options: [ { text: "He comido (perfecto compuesto).", correct: true }, { text: "Comí (perfecto simple).", correct: false }, { text: "Comía (imperfecto).", correct: false }, { text: "Como (presente).", correct: false } ], detailedExplanation: "Correct: Hoy <strong>he comido</strong> paella.\n\nWhy <strong>compuesto</strong>?\n• 'Hoy' is still the current day — the time frame is not over.\n• The past action is connected to the present.\n\nWe do not use <strong>comí</strong> (simple) with hoy for a recent action in the same day; that would suggest the day is over.\n\nRule: hoy, esta mañana, esta semana (when still in that period) → <strong>perfecto compuesto</strong>.", illustration: "Hoy / Esta semana (still ongoing)\n  → perfecto compuesto\n\n  Hoy he comido / Esta semana he ido\n  (period not finished)", priority: 11 },
    { id: "q12", title: "El año pasado ___ (viajar) a México.", shortExplanation: "Viajé (perfecto simple).", options: [ { text: "Viajé (perfecto simple).", correct: true }, { text: "He viajado (perfecto compuesto).", correct: false }, { text: "Viajaba (imperfecto).", correct: false }, { text: "Viajaré (futuro).", correct: false } ], detailedExplanation: "Correct: El año pasado <strong>viajé</strong> a México.\n\nWhy <strong>simple</strong>?\n• 'El año pasado' is a completed time period.\n• The action is viewed as finished, with no need to link it to the present.\n\nIf we said <strong>he viajado</strong> it would suggest a period that still includes 'now' (e.g. este año he viajado a México).\n\nRule: finished periods (el año pasado, hace dos años, en 2019) → <strong>perfecto simple</strong>.", illustration: "Finished period → perfecto simple\n\n  El año pasado viajé\n  Hace dos años compré\n  En 2019 nació mi hijo", priority: 12 },
    { id: "q13", title: "Mientras ___ (estudiar), sonó el teléfono.", shortExplanation: "Estudiaba (imperfecto).", options: [ { text: "Estudiaba (imperfecto).", correct: true }, { text: "Estudié (perfecto simple).", correct: false }, { text: "He estudiado (perfecto compuesto).", correct: false }, { text: "Estaba estudiando (imperfecto progresivo).", correct: false } ], detailedExplanation: "Correct: Mientras <strong>estudiaba</strong>, <strong>sonó</strong> el teléfono.\n\nWhy?\n• <strong>Estudiaba</strong> = action in progress (background) → <strong>imperfecto</strong>.\n• <strong>Sonó</strong> = single event that interrupts → <strong>perfecto simple</strong>.\n\nPattern: Mientras + [<strong>imperfecto</strong>], [<strong>simple</strong>].\n\nAnother example: Mientras <strong>cocinaba</strong>, <strong>se quemó</strong> la tortilla.\n\nSummary:\n• Ongoing or background action → <strong>imperfecto</strong>.\n• Interrupting or completed event → <strong>simple</strong>.", illustration: "Mientras [imperfecto], [simple].\n\n  Background (ongoing)  → imperfecto\n  Interrupting event    → simple\n\n  Mientras leía, entró mi hermano.", priority: 13 },
    { id: "q14", title: "Esta semana ___ (trabajar) mucho.", shortExplanation: "He trabajado (perfecto compuesto).", detailedExplanation: "Correct: Esta semana <strong>he trabajado</strong> mucho.\n\nWhy <strong>compuesto</strong>?\n• 'Esta semana' typically includes today and is not over yet.\n• The action is in the past but the time frame is still current.\n\nIf the week were over we would say La semana pasada <strong>trabajé</strong> mucho (<strong>simple</strong>).\n\nRule: esta semana, este mes, este año (when still in that period) → <strong>perfecto compuesto</strong>.", illustration: "Esta semana / Este mes (ongoing)\n  → perfecto compuesto\n\n  Esta semana he trabajado\n  Este año hemos viajado tres veces", priority: 14 },
    { id: "q15", title: "¿A qué hora es la reunión? ___ a las diez.", shortExplanation: "Es (ser).", options: [ { text: "Es (ser).", correct: true }, { text: "Está (estar).", correct: false }, { text: "Son (ser).", correct: false }, { text: "Están (estar).", correct: false } ], detailedExplanation: "Correct: <strong>Es</strong> a las diez.\n\nWhy <strong>ser</strong>?\n• We are stating the time or when something is scheduled.\n• Time and dates use <strong>ser</strong>: <strong>Es</strong> la una, <strong>Son</strong> las diez, La cita <strong>es</strong> el lunes.\n\nThe question '¿A qué hora es...?' sets the context (time).\n\nWe do not use estar for time. <strong>Estar</strong> = location or temporary state (La reunión está en la sala 3; Estoy listo).", illustration: "Time / schedule → SER\n\n  Es la una.  Son las diez.\n  La reunión es a las diez.\n  La clase es el lunes.", priority: 15 },
    { id: "q16", title: "María no ha dormido bien. ___ cansada hoy.", shortExplanation: "Está (estar).", options: [ { text: "Está (estar).", correct: true }, { text: "Es (ser).", correct: false }, { text: "Estaban (estar).", correct: false }, { text: "Estará (estar, futuro).", correct: false } ], detailedExplanation: "Correct: María <strong>está</strong> cansada hoy.\n\nWhy <strong>estar</strong>?\n• The first sentence (no ha dormido bien) gives context: she is tired in this moment.\n• Temporary physical or emotional state → <strong>estar</strong>.\n\nCompare:\n• María <strong>es</strong> simpática (trait) → <strong>ser</strong>.\n• María <strong>está</strong> contenta hoy (state) → <strong>estar</strong>.\n\nRule: temporary state or condition → <strong>estar</strong>; permanent characteristic → <strong>ser</strong>.", illustration: "Temporary state → ESTAR\n\n  Está cansada / enferma / contenta\n  (how she is now, can change)", priority: 16 },
    { id: "q17", title: "Trabaja en el hospital. Él ___ médico.", shortExplanation: "Es (ser).", detailedExplanation: "Correct: Él <strong>es</strong> médico.\n\nWhy <strong>ser</strong>?\n• The context (trabaja en el hospital) supports that we are stating his profession.\n• Profession is part of identity → <strong>ser</strong>.\n\nWe do not use <strong>estar</strong> for professions.\n\n<strong>Estar</strong> would be for where he is or how he is at the moment (<strong>Está</strong> en el hospital; <strong>Está</strong> ocupado).", illustration: "Profession → SER\n\n  Soy profesor.  Es médico.\n  (identity / occupation)", priority: 17 },
    { id: "q18", title: "Acabo de probar la sopa. La sopa ___ deliciosa.", shortExplanation: "Está (estar).", options: [ { text: "Está (estar).", correct: true }, { text: "Es (ser).", correct: false }, { text: "Estaba (estar).", correct: false }, { text: "Estará (estar).", correct: false } ], detailedExplanation: "Correct: La sopa <strong>está</strong> deliciosa.\n\nWhy <strong>estar</strong>?\n• The first sentence (Acabo de probar la sopa) gives context: this bowl, right now — your experience at this moment.\n• This particular moment → <strong>estar</strong>.\n\nIf the context were general (e.g. Es la especialidad de la casa. La sopa ___ deliciosa), we would use <strong>es</strong> (<strong>ser</strong>): the soup as a characteristic of the dish.", illustration: "Context decides ser vs estar (taste):\n\n  Acabo de probarla  → está (this moment)\n  Es la especialidad  → es (in general)", priority: 18 },
    { id: "q19", title: "Es la especialidad de la casa. La sopa ___ deliciosa.", shortExplanation: "Es (ser).", options: [ { text: "Es (ser).", correct: true }, { text: "Está (estar).", correct: false }, { text: "Era (ser).", correct: false }, { text: "Estaba (estar).", correct: false } ], detailedExplanation: "Correct: La sopa <strong>es</strong> deliciosa.\n\nWhy <strong>ser</strong>?\n• The first sentence (Es la especialidad de la casa) gives context: the soup as a general quality of the restaurant — characteristically delicious.\n• General quality → <strong>ser</strong>.\n\nIf the context were about this moment (e.g. Acabo de probar la sopa. La sopa ___ deliciosa), we would use <strong>está</strong> (<strong>estar</strong>).", illustration: "Context decides ser vs estar (taste):\n\n  Es la especialidad  → es (in general)\n  Acabo de probarla  → está (this moment)", priority: 19 }
  ];

  function escapeHtml(text) {
    var div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function shuffle(array) {
    var out = array.slice();
    for (var i = out.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var t = out[i]; out[i] = out[j]; out[j] = t;
    }
    return out;
  }

  function pickWrongOptions(questions, correctQuestion, count) {
    var others = questions.filter(function (q) { return q.id !== correctQuestion.id; });
    return shuffle(others).slice(0, count).map(function (q) { return q.shortExplanation; });
  }

  function buildOptions(question, all) {
    if (question.options && Array.isArray(question.options) && question.options.length === 4) {
      return shuffle(question.options.slice());
    }
    var wrong = pickWrongOptions(all, question, 3);
    var options = [{ text: question.shortExplanation, correct: true }].concat(wrong.map(function (text) { return { text: text, correct: false }; }));
    return shuffle(options);
  }

  function parseFailedIds() {
    try {
      var raw = localStorage.getItem(STORAGE_FAILED_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) { return []; }
  }

  function buildOrder(questions, count, failedIds) {
    var total = questions.length;
    var failedIndices = [];
    var otherIndices = [];
    for (var i = 0; i < total; i++) {
      if (failedIds.indexOf(questions[i].id) !== -1) failedIndices.push(i);
      else otherIndices.push(i);
    }
    return shuffle(failedIndices).concat(shuffle(otherIndices)).slice(0, count);
  }

  function QuizApp() {
    var self = this;
    this.questions = QUESTIONS.slice();
    this.order = [];
    this.selectedCount = 0;
    this.index = 0;
    this.currentOptions = [];
    this.answered = false;
    this.sessionResults = [];

    this.el = {
      dashboardSection: document.getElementById("dashboard-section"),
      totalCount: document.getElementById("total-count"),
      questionCount: document.getElementById("question-count"),
      failedHint: document.getElementById("failed-hint"),
      startBtn: document.getElementById("start-btn"),
      progress: document.getElementById("progress"),
      quizSection: document.getElementById("quiz-section"),
      resultSection: document.getElementById("result-section"),
      questionTitle: document.getElementById("question-title"),
      questionIllustration: document.getElementById("question-illustration"),
      optionsList: document.getElementById("options-list"),
      resultBadge: document.getElementById("result-badge"),
      resultTitle: document.getElementById("result-title"),
      resultIllustration: document.getElementById("result-illustration"),
      resultShort: document.getElementById("result-short"),
      resultDetailed: document.getElementById("result-detailed"),
      nextBtn: document.getElementById("next-btn"),
      sessionSummarySection: document.getElementById("session-summary-section"),
      sessionStats: document.getElementById("session-stats"),
      sessionFailedWrap: document.getElementById("session-failed-wrap"),
      sessionFailedList: document.getElementById("session-failed-list"),
      sessionNextTip: document.getElementById("session-next-tip"),
      dashboardChart: document.getElementById("dashboard-chart"),
      sessionChart: document.getElementById("session-chart"),
      backToDashboardBtn: document.getElementById("back-to-dashboard-btn"),
      themeToggle: document.getElementById("theme-toggle")
    };

    if (this.questions.length < 4) throw new Error("At least 4 questions are required for the quiz.");

    var stored = localStorage.getItem(STORAGE_THEME_KEY);
    var prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    document.documentElement.setAttribute("data-theme", stored || (prefersDark ? "dark" : "light"));
    updateThemeIcon();

    document.addEventListener("keydown", function (e) {
      var tag = document.activeElement && document.activeElement.tagName;
      var inInput = tag === "INPUT" || tag === "TEXTAREA";
      if (e.key === "t" || e.key === "T") {
        if (!inInput) { self.toggleTheme(); e.preventDefault(); }
        return;
      }
      if (e.key === "Enter" && !inInput) {
        if (!self.el.dashboardSection.classList.contains("hidden")) {
          self.startQuiz();
          e.preventDefault();
          return;
        }
        if (self.answered && !self.el.resultSection.classList.contains("hidden")) {
          self.next();
          e.preventDefault();
          return;
        }
      }
      if (self.answered) return;
      var n = parseInt(e.key, 10);
      if (n >= 1 && n <= 4) {
        var option = self.el.optionsList.querySelector("[data-index=\"" + (n - 1) + "\"]");
        if (option && !option.classList.contains("option--disabled")) { option.click(); e.preventDefault(); }
      }
    });

    this.el.themeToggle.addEventListener("click", function () { self.toggleTheme(); });
    document.getElementById("dashboard-form").addEventListener("submit", function (e) { e.preventDefault(); self.startQuiz(); });
    document.getElementById("result-form").addEventListener("submit", function (e) { e.preventDefault(); self.next(); });
    this.el.backToDashboardBtn.addEventListener("click", function () { self.showDashboard(); });
    if (window.matchMedia("(pointer: fine)").matches) {
      self.el.themeToggle.setAttribute("title", "Toggle dark/light theme (keyboard: T)");
      self.el.nextBtn.setAttribute("title", "Next question (keyboard: Enter)");
    }
    document.getElementById("tab-quiz").addEventListener("click", function () { self.showPage("quiz"); });
    document.getElementById("tab-learn").addEventListener("click", function () { self.showPage("learn"); });
    this.showPage("quiz");
    this.showDashboard();
  };

  QuizApp.prototype.showPage = function (name) {
    var quizTab = document.getElementById("tab-quiz");
    var learnTab = document.getElementById("tab-learn");
    var quizPage = document.getElementById("page-quiz");
    var learnPage = document.getElementById("page-learn");
    if (name === "quiz") {
      quizTab.classList.add("active");
      quizTab.setAttribute("aria-selected", "true");
      learnTab.classList.remove("active");
      learnTab.setAttribute("aria-selected", "false");
      quizPage.classList.add("active");
      quizPage.removeAttribute("hidden");
      learnPage.classList.remove("active");
      learnPage.setAttribute("hidden", "");
    } else {
      learnTab.classList.add("active");
      learnTab.setAttribute("aria-selected", "true");
      quizTab.classList.remove("active");
      quizTab.setAttribute("aria-selected", "false");
      learnPage.classList.add("active");
      learnPage.removeAttribute("hidden");
      quizPage.classList.remove("active");
      quizPage.setAttribute("hidden", "");
      this.renderLearnPage();
      document.getElementById("learn-search-box").focus();
    }
  };

  QuizApp.prototype.renderLearnPage = function () {
    var listEl = document.getElementById("learn-list");
    if (listEl.hasAttribute("data-rendered")) {
      this.filterLearnList();
      return;
    }
    listEl.setAttribute("data-rendered", "true");
    var sorted = this.questions.slice().sort(function (a, b) { return a.priority - b.priority; });
    for (var i = 0; i < sorted.length; i++) {
      var q = sorted[i];
      var searchText = (q.title + " " + q.detailedExplanation + (q.illustration ? " " + q.illustration : "")).toLowerCase();
      var li = document.createElement("li");
      li.className = "learn-item";
      li.id = "learn-" + q.id;
      li.setAttribute("data-search", searchText);
      var btn = document.createElement("button");
      btn.type = "button";
      btn.className = "learn-btn";
      btn.textContent = q.title;
      var spoiler = document.createElement("div");
      spoiler.className = "learn-spoiler";
      var p = document.createElement("p");
      p.textContent = q.detailedExplanation;
      spoiler.appendChild(p);
      if (q.illustration) {
        var pre = document.createElement("pre");
        pre.textContent = q.illustration;
        spoiler.appendChild(pre);
      }
      li.appendChild(btn);
      li.appendChild(spoiler);
      listEl.appendChild(li);
    }
    var self = this;
    listEl.querySelectorAll(".learn-btn").forEach(function (btn) {
      btn.addEventListener("click", function () {
        var item = btn.closest(".learn-item");
        item.classList.toggle("expanded");
      });
    });
    document.getElementById("learn-collapse-btn").addEventListener("click", function () {
      listEl.querySelectorAll(".learn-item.expanded").forEach(function (item) {
        item.classList.remove("expanded");
      });
    });
    document.getElementById("learn-expand-btn").addEventListener("click", function () {
      listEl.querySelectorAll(".learn-item").forEach(function (item) {
        if (!item.classList.contains("no-match")) item.classList.add("expanded");
      });
    });
    var debounceFilter = debounce(function () { self.filterLearnList(); }, 150);
    document.getElementById("learn-search-box").addEventListener("input", debounceFilter);
    this.filterLearnList();
  };

  function debounce(fn, delay) {
    var t = null;
    return function () {
      clearTimeout(t);
      t = setTimeout(fn, delay);
    };
  }

  QuizApp.prototype.filterLearnList = function () {
    var searchBox = document.getElementById("learn-search-box");
    var listEl = document.getElementById("learn-list");
    var countEl = document.getElementById("learn-count");
    var noResultsEl = document.getElementById("learn-no-results");
    if (!searchBox || !listEl || !countEl) return;
    var q = (searchBox.value || "").trim().toLowerCase();
    var visible = 0;
    listEl.querySelectorAll(".learn-item").forEach(function (item) {
      var match = !q || item.getAttribute("data-search").indexOf(q) !== -1;
      if (match) {
        item.classList.remove("no-match");
        visible++;
      } else {
        item.classList.add("no-match");
      }
    });
    countEl.textContent = visible + " topic" + (visible !== 1 ? "s" : "");
    if (noResultsEl) noResultsEl.classList.toggle("hidden", visible > 0);
  };

  QuizApp.prototype.toggleTheme = function () {
    var current = document.documentElement.getAttribute("data-theme") || "light";
    document.documentElement.setAttribute("data-theme", current === "dark" ? "light" : "dark");
    localStorage.setItem(STORAGE_THEME_KEY, current === "dark" ? "light" : "dark");
    updateThemeIcon();
  };

  function updateThemeIcon() {
    var theme = document.documentElement.getAttribute("data-theme") || "light";
    var btn = document.getElementById("theme-toggle");
    if (btn) btn.textContent = theme === "dark" ? "\u263E" : "\u2600";
  }

  QuizApp.prototype.showDashboard = function () {
    var total = this.questions.length;
    this.el.totalCount.textContent = String(total);
    var failedIds = parseFailedIds();
    var failedCount = failedIds.length;
    var restCount = Math.max(0, total - failedCount);
    var failedPct = total > 0 ? (failedCount / total) * 100 : 0;
    var restPct = total > 0 ? (restCount / total) * 100 : 0;
    this.el.dashboardChart.innerHTML = "<div class=\"stats-chart-bar\" role=\"img\" aria-label=\"Quiz pool: " + failedCount + " to review, " + restCount + " rest\"><div class=\"stats-chart-segment segment-failed\" style=\"width:" + failedPct + "%\"></div><div class=\"stats-chart-segment segment-rest\" style=\"width:" + restPct + "%\"></div></div><p class=\"stats-chart-legend\"><span><span class=\"dot dot-failed\" aria-hidden=\"true\"></span>To review: " + failedCount + "</span><span><span class=\"dot dot-rest\" aria-hidden=\"true\"></span>Rest: " + restCount + "</span></p>";
    this.el.questionCount.innerHTML = "";
    for (var n = 1; n <= total; n++) {
      var opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n === total ? n + " (all)" : String(n);
      this.el.questionCount.appendChild(opt);
    }
    if (total > 0) this.el.questionCount.value = Math.min(5, total);
    if (failedCount > 0) {
      this.el.failedHint.textContent = failedCount + " question(s) need more practice. They will appear first in this try.";
      this.el.failedHint.classList.remove("hidden");
    } else {
      this.el.failedHint.classList.add("hidden");
    }
    this.el.dashboardSection.classList.remove("hidden");
    this.el.quizSection.classList.add("hidden");
    this.el.resultSection.classList.add("hidden");
    this.el.sessionSummarySection.classList.add("hidden");
  };

  QuizApp.prototype.startQuiz = function () {
    var count = parseInt(this.el.questionCount.value, 10) || this.questions.length;
    count = Math.max(1, Math.min(count, this.questions.length));
    var failedIds = parseFailedIds();
    this.order = buildOrder(this.questions, count, failedIds);
    this.selectedCount = this.order.length;
    this.index = 0;
    this.sessionResults = [];
    this.el.dashboardSection.classList.add("hidden");
    this.el.quizSection.classList.remove("hidden");
    this.el.sessionSummarySection.classList.add("hidden");
    this.showQuestion();
  };

  QuizApp.prototype.getSessionStats = function () {
    var correct = 0, wrong = 0, failedIds = [];
    for (var i = 0; i < this.sessionResults.length; i++) {
      if (this.sessionResults[i].correct) correct++; else { wrong++; failedIds.push(this.sessionResults[i].id); }
    }
    return { correct: correct, wrong: wrong, failedIds: failedIds };
  };

  QuizApp.prototype.showSessionSummary = function () {
    var stats = this.getSessionStats();
    localStorage.setItem(STORAGE_FAILED_KEY, JSON.stringify(stats.failedIds));
    var total = this.sessionResults.length;
    var correctPct = total > 0 ? (stats.correct / total) * 100 : 0;
    var wrongPct = total > 0 ? (stats.wrong / total) * 100 : 0;
    this.el.sessionChart.innerHTML = "<div class=\"stats-chart-bar\" role=\"img\" aria-label=\"Correct: " + stats.correct + ", Wrong: " + stats.wrong + "\"><div class=\"stats-chart-segment segment-correct\" style=\"width:" + correctPct + "%\"></div><div class=\"stats-chart-segment segment-wrong\" style=\"width:" + wrongPct + "%\"></div></div><p class=\"stats-chart-legend\"><span><span class=\"dot dot-correct\" aria-hidden=\"true\"></span>Correct: " + stats.correct + "</span><span><span class=\"dot dot-wrong\" aria-hidden=\"true\"></span>Wrong: " + stats.wrong + "</span></p>";
    var pct = total > 0 ? Math.round((stats.correct / total) * 100) : 0;
    this.el.sessionStats.textContent = "Correct: " + stats.correct + " · Wrong: " + stats.wrong + " (of " + total + ") — " + pct + "%";
    if (stats.failedIds.length > 0) {
      this.el.sessionFailedWrap.classList.remove("hidden");
      this.el.sessionFailedList.innerHTML = "";
      var self = this;
      stats.failedIds.forEach(function (id) {
        var q = self.questions.filter(function (q) { return q.id === id; })[0];
        if (q) {
          var li = document.createElement("li");
          li.textContent = q.title;
          self.el.sessionFailedList.appendChild(li);
        }
      });
      this.el.sessionNextTip.textContent = "These will be suggested first when you start your next try.";
    } else {
      this.el.sessionFailedWrap.classList.add("hidden");
      this.el.sessionNextTip.textContent = "Great — no failed questions this time.";
    }
    this.el.quizSection.classList.add("hidden");
    this.el.resultSection.classList.add("hidden");
    this.el.sessionSummarySection.classList.remove("hidden");
    this.el.backToDashboardBtn.focus();
  };

  QuizApp.prototype.showQuestion = function () {
    this.answered = false;
    var q = this.questions[this.order[this.index]];
    this.currentOptions = buildOptions(q, this.questions);

    var correctSoFar = 0, wrongSoFar = 0;
    for (var i = 0; i < this.sessionResults.length; i++) {
      if (this.sessionResults[i].correct) correctSoFar++; else wrongSoFar++;
    }
    this.el.progress.innerHTML = "Question " + (this.index + 1) + " of " + this.order.length + " · <span class=\"quiz-stats\">Correct: <span class=\"correct-num\">" + correctSoFar + "</span> · Wrong: <span class=\"wrong-num\">" + wrongSoFar + "</span></span>";
    this.el.questionTitle.textContent = q.title;
    this.el.questionIllustration.textContent = "";

    this.el.optionsList.innerHTML = "";
    var self = this;
    this.currentOptions.forEach(function (opt, i) {
      var li = document.createElement("li");
      li.setAttribute("role", "option");
      li.setAttribute("data-index", String(i));
      li.className = "option";
      li.innerHTML = "<span class=\"option-num\" aria-hidden=\"true\">" + (i + 1) + ".</span> " + escapeHtml(opt.text);
      li.addEventListener("click", function () { self.selectOption(i); });
      self.el.optionsList.appendChild(li);
    });

    this.el.quizSection.classList.remove("hidden");
    this.el.resultSection.classList.add("hidden");
    var isLast = this.index >= this.order.length - 1;
    this.el.nextBtn.textContent = isLast ? "Finish" : "Next question";
  };

  QuizApp.prototype.selectOption = function (optionIndex) {
    if (this.answered) return;
    this.answered = true;

    var opt = this.currentOptions[optionIndex];
    var optionElements = this.el.optionsList.querySelectorAll(".option");
    for (var i = 0; i < optionElements.length; i++) {
      var item = optionElements[i];
      item.classList.add("option--disabled");
      if (this.currentOptions[i].correct) item.classList.add("option--correct");
      else if (i === optionIndex) item.classList.add("option--wrong");
    }

    var q = this.questions[this.order[this.index]];
    this.sessionResults.push({ id: q.id, correct: opt.correct });
    this.el.resultBadge.textContent = opt.correct ? "Correct" : "Wrong";
    this.el.resultBadge.className = "result-badge " + (opt.correct ? "result-badge--correct" : "result-badge--wrong");
    this.el.resultTitle.textContent = q.title;
    this.el.resultIllustration.textContent = q.illustration || "";
    this.el.resultShort.textContent = q.shortExplanation;
    this.el.resultDetailed.innerHTML = q.detailedExplanation;

    this.el.quizSection.classList.add("hidden");
    this.el.resultSection.classList.remove("hidden");
    this.el.nextBtn.disabled = false;
    this.el.nextBtn.focus();
    this.el.nextBtn.scrollIntoView({ behavior: "smooth", block: "nearest" });
  };

  QuizApp.prototype.next = function () {
    this.index++;
    if (this.index >= this.order.length) {
      this.showSessionSummary();
      return;
    }
    this.showQuestion();
  };

  document.addEventListener("DOMContentLoaded", function () { new QuizApp(); });
})();
  </script>
</body>
</html>
